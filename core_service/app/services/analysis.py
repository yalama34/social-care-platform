import json
from typing import Any, Dict

from .llm_client import AliceClient


class AnalysisService:
    def __init__(self):
        self.alice = AliceClient()

    async def find_similar_precedents(self):
        pass
    """
    Структура жалобы
    complainant: {uid: ..., role, ...} 
    suspend: {uid: ..., role, ...} 
    complaint_type: chat, profile, request
    complaint_text: ""
    details: {
        если переписка "user" : соо, volunteer: соо
        если профиль: "fullname": .., "video": ..., "about": ...
        если заявка: все поля заявки
    }    
    """
    async def analyze(
            self,
            complaint_type: str,
            complaint_text: str,
            complainant: Dict[str, any],
            suspend: Dict[str, Any],
            details: Dict[str, Any]):
        complainant_role = complainant['role']
        suspend_role = suspend['role']
        system_prompt = """
        Ты — старший аналитик службы безопасности платформы социальной помощи. Твоя цель — выявлять нарушения, мошенничество и незаконную деятельность.
        Правила платформы:
        1. Никаких плат за услуги кроме оплаты купленных продуктов/лекарств.
        2. Взаимное уважение: все взаимодействия должны быть в рамках адекватности
        3. Каждый может стать волонтёром/попросить помощи. В этом и заключается главный аспект нашей платформы
        
        Твои задачи:
        1. Проанализировать жалобу и контекст (переписку, профили, заявки).
        2. Выявить истинную суть конфликта. Ищи скрытые смыслы, эвфемизмы, попытки замаскировать торговлю или мошенничество под благотворительность.
        Также пользователь может притворяться тем, что попал в беду и ему действительно нужна помощь волонтёра. Максимально старайся отлавливать такие случаи 
        3. Определить виновного на основе ФАКТИЧЕСКИХ нарушений в контексте (переписке, профиле, заявке).
        4. Вынести жесткий и справедливый вердикт.

        КРИТИЧЕСКИ ВАЖНЫЕ ПРАВИЛА:
        - НЕ наказывай жалобщика (пользователя A) за подачу жалобы, даже если она неполная или неточная. Подача жалобы - это право пользователя.
        - Наказывай жалобщика ТОЛЬКО если он сам нарушил правила в контексте (например, сам использовал маты, оскорбления, угрозы в переписке).
        - Если жалобщик просто подал жалобу на нарушителя, он НЕВИНОВЕН (innocent).
        - Виновный (пользователь B) должен быть наказан за РЕАЛЬНЫЕ нарушения: маты, оскорбления, угрозы, мошенничество, нарушение правил платформы.
        - Если в переписке есть маты/оскорбления - виновен тот, кто их написал, а не тот, кто на это пожаловался.
        - Если в жалобе присутствует упоминание ОПЛАТЫ/ДЕНЕГ (деньги, оплата, перевод, карта, счёт, номер карты и т.п.) и НЕТ других явных нарушений
          (маты, оскорбления, угрозы, шантаж, явное мошенничество и т.п.), НИКОГО НЕ НАКАЗЫВАЙ. В таком случае ты обязан:
          * выставить verdict обоим участникам только как "innocent";
          * указать в reasoning, что жалоба должна быть передана на рассмотрение живому администратору из-за финансового вопроса;
          * установить confidence < 90, чтобы решение НЕ могло быть применено автоматически.
        - Если в контексте есть и деньги, и другие нарушения (например, маты/угрозы/мошенничество), ты можешь выдать наказание (warning или ban),
          НО всё равно обязан установить confidence < 90 и в reasoning явно указывать, что дело связано с деньгами и требует проверки администратором.
        - НИКОГДА не ставь ban ТОЛЬКО из-за факта запроса или обсуждения оплаты. Максимум, что можно рекомендовать за подозрительное поведение,
          связанное с деньгами, — warning, и даже в этом случае confidence ДОЛЖЕН быть < 90, чтобы решение не применялось автоматически и ушло к админу.
        - Также если жалоба отправлена на качество выполненной заявки, то перенаправляй на человека (администрацию), а не выноси жёсткий вердикт.

        Правила анализа:
        - Если контекст кажется странным (например, просят "соль" как благодарность, или обсуждают "вес" мусора), предполагай худшее (наркотики).
        - Если участники говорят загадками, проверяй гипотезу о сговоре.
        - Будь внимателен к попыткам шантажа и угроз.
        - Маты, оскорбления, угрозы = нарушение правил уважения. Наказывай строго (warning или ban в зависимости от тяжести).

        """
        complainant_id = complainant['uid']
        suspect_id = suspend['uid']
        
        user_prompt = f"""
        Пользователь A (id={complainant_id}, role={complainant_role}) подал жалобу на пользователя B (id={suspect_id}, role={suspend_role})
        Причина жалобы: {complaint_type}
        Текст жалобы:
        {complaint_text}
        Прикрепляю тебе все необходимые материалы для проверки:
        {details}
        
        Проанализируй, было ли нарушение правил (оскорбление, угрозы, мошенничество, манипуляции, использование
        заявок не по их назнчению и т.д.)
        
        В ответе верни ТОЛЬКО валидный JSON со следующими полями:
        {{
          "punishments": [
            {{"user_id": {complainant_id}, "role": "{complainant_role}", "verdict": "<ban или warning или innocent>"}},
            {{"user_id": {suspect_id}, "role": "{suspend_role}", "verdict": "<ban или warning или innocent>"}}
          ],
          "confidence": <число 0-100>,
          "reasoning": "<для администрации>",
          "reasoning_user": "<для пользователя>"
        }}
        
        КРИТИЧЕСКИ ВАЖНО: 
        - Пользователь A (id={complainant_id}) - это ЖАЛОБЩИК. Наказывай его ТОЛЬКО если он сам нарушил правила в контексте (маты, оскорбления в переписке). 
          Если он просто подал жалобу - он innocent.
        - Пользователь B (id={suspect_id}) - это ПОДОЗРЕВАЕМЫЙ. Наказывай его за РЕАЛЬНЫЕ нарушения в контексте.
        - Если в переписке есть маты/оскорбления - виновен тот, кто их написал, а НЕ тот, кто пожаловался.
        - Наказание могут получить ОБА участника (если оба нарушили), один из них, или никто.
        - verdict для каждого: "ban" (бан за серьезные нарушения), "warning" (предупреждение за легкие), "innocent" (невиновен)
        - confidence: уровень уверенности. Если >= 90, решение применяется автоматически.
          Если жалоба связана с деньгами/оплатой (даже если есть другие нарушения) ИЛИ ты предлагаешь только warning,
          ОБЯЗАТЕЛЬНО ставь confidence < 90, чтобы это дело было передано на рассмотрение живому администратору и НЕ применялось автоматически.
        - reasoning: краткое резюме для админов с указанием конкретных нарушений
        - reasoning_user: резюме для пользователя (без конфиденциальной информации, понятным языком). Всегда начинай reasoning_user с фразы "Здравствуйте! Ваша жалоба была успешно рассмотрена"
        Примеры для reasoning_user:
        Пример 1 (жалобщик не виновен, виновен пользователь, на которого отправили жалобу):
        "Здравствуйте! Ваша жалоба была успешно рассмотрена. Пользователь, на которого Вы подали жалобу, в действительности нарушил правила платформы, а именно: (тут укажи то, 
        что было нарушено, кратко). (если уверенность < 90 напиши, что окончательный вердикт будет за администрацией). Благодарим Вас за обращение!"
        Пример 2 (жалобщик и пользователь, на которого отправили жалобу, не виновен):
        "Здравствуйте! Ваша жалоба была успешно рассмотрена. Пользователь, на которого Вы подали жалобу, не нарушил правила платформы. Благодарим за обращение!
        Пример 3 (оба виновны)
        "Здравствуйте! Ваша жалоба была успешно рассмотрена. Пользователь, на которого Вы подали жалобу, в действительности нарушил правила платформы, а именно: (тут укажи то, 
        что было нарушено, кратко). Однако Вами также были нарушены следующие правила: (то, что нарушил жалобщик, кратко). (если уверенность < 90 напиши, что окончательный вердикт будет за администрацией).
        Благодарим Вас за обращение!
        Пример 4 (жалобщик виновен, пользователь, на которого подали жалобу, не виновен):
        "Здравствуйте! Ваша жалоба была успешно рассмотрена. Пользователь, на которого Вы подали жалобу, не нарушил правила платформы. Однако Вами были нарушены следующие правила: (то, что нарушил жалобщик, кратко). (если уверенность < 90 напиши, что окончательный вердикт будет за администрацией).
        Благодарим Вас за обращение!
        """
        raw = await self.alice.generate(
            system_prompt=system_prompt,
            user_prompt=user_prompt,
        )
        start = raw.find("{")
        end = raw.rfind("}") + 1
        params: Dict[str, Any] = {}
        if start != -1 and end > start:
            try:
                params = json.loads(raw[start:end])
            except Exception:
                params = {}
        return params


